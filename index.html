import React, { useState, useMemo } from 'react';
import { 
  Plus, 
  DollarSign, 
  TrendingUp, 
  TrendingDown, 
  Package, 
  Check, 
  X, 
  Smartphone,
  CalendarDays
} from 'lucide-react';

// Dados iniciais de exemplo para você ver como o sistema funciona
const dadosIniciais = [
  { id: 1, name: 'iPhone 13 128GB', purchasePrice: 2000, purchaseDate: '2026-01-15', salePrice: 2800, saleDate: '2026-01-20', status: 'vendido' },
  { id: 2, name: 'Samsung Galaxy S22', purchasePrice: 1500, purchaseDate: '2026-01-28', salePrice: 2100, saleDate: '2026-02-05', status: 'vendido' },
  { id: 3, name: 'MacBook Air M1', purchasePrice: 3500, purchaseDate: '2026-02-10', salePrice: null, saleDate: null, status: 'estoque' },
  { id: 4, name: 'iPad Pro 11"', purchasePrice: 2200, purchaseDate: '2026-02-15', salePrice: null, saleDate: null, status: 'estoque' }
];

export default function App() {
  // Estados do Aplicativo
  const [products, setProducts] = useState(dadosIniciais);
  const [selectedMonth, setSelectedMonth] = useState('all');
  
  // Estado para o formulário de novo produto
  const [newProduct, setNewProduct] = useState({
    name: '',
    purchasePrice: '',
    purchaseDate: new Date().toISOString().split('T')[0]
  });

  // Estado para o formulário de venda (quando o usuário clica em "Vender")
  const [sellingId, setSellingId] = useState(null);
  const [saleForm, setSaleForm] = useState({ price: '', date: '' });

  // Funções de Formatação
  const formatCurrency = (value) => {
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
  };

  const formatDate = (dateString) => {
    if (!dateString) return '-';
    try {
      const [year, month, day] = dateString.split('-');
      return `${day}/${month}/${year}`;
    } catch (error) {
      return dateString;
    }
  };

  const formatMonthLabel = (monthStr) => {
    if (!monthStr || monthStr === 'all') return 'Todo o Período';
    try {
      const [year, month] = monthStr.split('-');
      const date = new Date(parseInt(year, 10), parseInt(month, 10) - 1, 1);
      const label = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
      return label.charAt(0).toUpperCase() + label.slice(1);
    } catch (error) {
      return monthStr;
    }
  };

  // Lógica para listar os meses disponíveis baseado nos dados
  const availableMonths = useMemo(() => {
    const months = new Set();
    const currentDate = new Date();
    // Adiciona o mês atual sempre
    months.add(`${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`);

    products.forEach(p => {
      if (p.purchaseDate) months.add(p.purchaseDate.substring(0, 7));
      if (p.saleDate) months.add(p.saleDate.substring(0, 7));
    });

    return Array.from(months).sort().reverse();
  }, [products]);

  // Cálculos do Dashboard baseado no mês selecionado (Fluxo de Caixa)
  const dashboardMetrics = useMemo(() => {
    let totalCost = 0;
    let totalRevenue = 0;

    products.forEach(p => {
      const pMonth = p.purchaseDate ? p.purchaseDate.substring(0, 7) : null;
      const sMonth = p.saleDate ? p.saleDate.substring(0, 7) : null;

      if (selectedMonth === 'all') {
        totalCost += Number(p.purchasePrice) || 0;
        if (p.status === 'vendido') {
          totalRevenue += Number(p.salePrice) || 0;
        }
      } else {
        // Custo no mês selecionado (compras feitas neste mês)
        if (pMonth === selectedMonth) {
          totalCost += Number(p.purchasePrice) || 0;
        }
        // Receita no mês selecionado (vendas feitas neste mês)
        if (p.status === 'vendido' && sMonth === selectedMonth) {
          totalRevenue += Number(p.salePrice) || 0;
        }
      }
    });

    const totalProfit = totalRevenue - totalCost;

    return { totalCost, totalRevenue, totalProfit };
  }, [products, selectedMonth]);

  // Ações
  const handleAddProduct = (e) => {
    e.preventDefault();
    if (!newProduct.name || !newProduct.purchasePrice || !newProduct.purchaseDate) return;

    const product = {
      id: Date.now(),
      name: newProduct.name,
      purchasePrice: parseFloat(newProduct.purchasePrice),
      purchaseDate: newProduct.purchaseDate,
      status: 'estoque',
      salePrice: null,
      saleDate: null
    };

    setProducts([product, ...products]);
    setNewProduct({ name: '', purchasePrice: '', purchaseDate: new Date().toISOString().split('T')[0] });
  };

  const handleStartSell = (product) => {
    setSellingId(product.id);
    setSaleForm({ 
      price: product.purchasePrice.toString(), // Sugere o preço de compra como base
      date: new Date().toISOString().split('T')[0] 
    });
  };

  const handleConfirmSell = (id) => {
    if (!saleForm.price || !saleForm.date) return;

    setProducts(products.map(p => {
      if (p.id === id) {
        return {
          ...p,
          status: 'vendido',
          salePrice: parseFloat(saleForm.price),
          saleDate: saleForm.date
        };
      }
      return p;
    }));
    setSellingId(null);
  };

  const handleDelete = (id) => {
    if(confirm('Tem certeza que deseja remover este registro?')) {
      setProducts(products.filter(p => p.id !== id));
    }
  }

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-12">
      {/* Header */}
      <header className="bg-indigo-600 text-white p-6 shadow-md">
        <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
          <div className="flex items-center gap-3">
            <Smartphone className="w-8 h-8 text-indigo-200" />
            <h1 className="text-2xl font-bold tracking-tight">TechRevenda PRO</h1>
          </div>
          
          {/* Seletor de Mês */}
          <div className="flex items-center gap-2 bg-indigo-700/50 rounded-lg p-2 border border-indigo-500/30">
            <CalendarDays className="w-5 h-5 text-indigo-200" />
            <select 
              className="bg-transparent text-white font-medium focus:outline-none cursor-pointer"
              value={selectedMonth}
              onChange={(e) => setSelectedMonth(e.target.value)}
            >
              <option value="all" className="text-slate-800">Todo o Período</option>
              {availableMonths.map(month => (
                <option key={month} value={month} className="text-slate-800">
                  {formatMonthLabel(month)}
                </option>
              ))}
            </select>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto px-4 sm:px-6 mt-8 space-y-8">
        
        {/* DASHBOARD - Valores Grandes */}
        <section className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {/* Card Custo */}
          <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex flex-col relative overflow-hidden group">
            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
              <TrendingDown className="w-24 h-24 text-red-500" />
            </div>
            <p className="text-slate-500 font-medium flex items-center gap-2">
              <span className="w-2 h-2 rounded-full bg-red-500"></span>
              Custo Total
            </p>
            <h2 className="text-4xl font-black text-slate-800 mt-2">
              {formatCurrency(dashboardMetrics.totalCost)}
            </h2>
            <p className="text-sm text-slate-400 mt-2">Valor investido em compras</p>
          </div>

          {/* Card Receita */}
          <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex flex-col relative overflow-hidden group">
             <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
              <TrendingUp className="w-24 h-24 text-blue-500" />
            </div>
            <p className="text-slate-500 font-medium flex items-center gap-2">
              <span className="w-2 h-2 rounded-full bg-blue-500"></span>
              Receita Total
            </p>
            <h2 className="text-4xl font-black text-slate-800 mt-2">
              {formatCurrency(dashboardMetrics.totalRevenue)}
            </h2>
            <p className="text-sm text-slate-400 mt-2">Valor bruto das vendas</p>
          </div>

          {/* Card Lucro */}
          <div className="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-6 shadow-md shadow-emerald-200 text-white flex flex-col relative overflow-hidden group transform hover:-translate-y-1 transition-transform">
             <div className="absolute top-0 right-0 p-4 opacity-20 group-hover:opacity-30 transition-opacity">
              <DollarSign className="w-24 h-24 text-white" />
            </div>
            <p className="font-medium text-emerald-50 flex items-center gap-2">
              <span className="w-2 h-2 rounded-full bg-white shadow-sm"></span>
              Lucro Líquido
            </p>
            <h2 className="text-5xl font-black mt-2 tracking-tight">
              {formatCurrency(dashboardMetrics.totalProfit)}
            </h2>
            <p className="text-sm text-emerald-100 mt-2">
              {dashboardMetrics.totalProfit >= 0 ? 'Resultado positivo no período' : 'Prejuízo no período'}
            </p>
          </div>
        </section>

        {/* Formulário de Cadastro */}
        <section className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
          <div className="bg-slate-50 border-b border-slate-200 px-6 py-4">
            <h3 className="text-lg font-bold text-slate-700 flex items-center gap-2">
              <Package className="w-5 h-5 text-indigo-500" />
              Cadastrar Nova Compra
            </h3>
          </div>
          <form onSubmit={handleAddProduct} className="p-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
              <div className="md:col-span-2">
                <label className="block text-sm font-medium text-slate-600 mb-1">Aparelho / Produto</label>
                <input 
                  type="text" 
                  required
                  placeholder="Ex: iPhone 12 Pro 256GB"
                  className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                  value={newProduct.name}
                  onChange={e => setNewProduct({...newProduct, name: e.target.value})}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-600 mb-1">Preço Pago (R$)</label>
                <input 
                  type="number" 
                  step="0.01"
                  required
                  placeholder="0.00"
                  className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                  value={newProduct.purchasePrice}
                  onChange={e => setNewProduct({...newProduct, purchasePrice: e.target.value})}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-600 mb-1">Data da Compra</label>
                <input 
                  type="date" 
                  required
                  className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-slate-700"
                  value={newProduct.purchaseDate}
                  onChange={e => setNewProduct({...newProduct, purchaseDate: e.target.value})}
                />
              </div>
            </div>
            <div className="mt-4 flex justify-end">
              <button 
                type="submit"
                className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-lg font-medium flex items-center gap-2 transition-colors shadow-sm"
              >
                <Plus className="w-5 h-5" />
                Adicionar ao Estoque
              </button>
            </div>
          </form>
        </section>

        {/* Lista de Produtos */}
        <section className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
          <div className="bg-slate-50 border-b border-slate-200 px-6 py-4 flex justify-between items-center">
            <h3 className="text-lg font-bold text-slate-700">Seus Aparelhos</h3>
            <span className="bg-slate-200 text-slate-600 text-xs font-bold px-3 py-1 rounded-full">
              {products.length} itens
            </span>
          </div>
          
          <div className="overflow-x-auto">
            <table className="w-full text-left border-collapse">
              <thead>
                <tr className="bg-slate-50/50 text-slate-500 text-sm border-b border-slate-200">
                  <th className="p-4 font-medium">Produto</th>
                  <th className="p-4 font-medium">Data Compra</th>
                  <th className="p-4 font-medium">Custo</th>
                  <th className="p-4 font-medium text-center">Status</th>
                  <th className="p-4 font-medium">Venda</th>
                  <th className="p-4 font-medium text-right">Ação</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {products.length === 0 ? (
                  <tr>
                    <td colSpan="6" className="p-8 text-center text-slate-400">
                      Nenhum produto cadastrado ainda. Adicione sua primeira compra acima!
                    </td>
                  </tr>
                ) : (
                  products.map(product => (
                    <tr key={product.id} className="hover:bg-slate-50 transition-colors group">
                      <td className="p-4 font-medium text-slate-800">{product.name}</td>
                      <td className="p-4 text-slate-500 text-sm">{formatDate(product.purchaseDate)}</td>
                      <td className="p-4 font-medium text-red-600">{formatCurrency(product.purchasePrice)}</td>
                      
                      <td className="p-4 text-center">
                        <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${
                          product.status === 'estoque' 
                            ? 'bg-amber-50 text-amber-700 border-amber-200' 
                            : 'bg-emerald-50 text-emerald-700 border-emerald-200'
                        }`}>
                          {product.status === 'estoque' ? 'Em Estoque' : 'Vendido'}
                        </span>
                      </td>

                      {/* Coluna de Venda (mostra valor ou formulário) */}
                      <td className="p-4">
                        {sellingId === product.id ? (
                          <div className="flex flex-col gap-2 min-w-[150px]">
                            <input 
                              type="number" 
                              placeholder="Valor Venda"
                              className="w-full px-2 py-1 text-sm border border-emerald-300 rounded focus:ring-1 focus:ring-emerald-500 outline-none"
                              value={saleForm.price}
                              onChange={e => setSaleForm({...saleForm, price: e.target.value})}
                              autoFocus
                            />
                            <input 
                              type="date" 
                              className="w-full px-2 py-1 text-sm border border-emerald-300 rounded focus:ring-1 focus:ring-emerald-500 outline-none"
                              value={saleForm.date}
                              onChange={e => setSaleForm({...saleForm, date: e.target.value})}
                            />
                          </div>
                        ) : (
                          <div className="flex flex-col">
                            <span className="font-medium text-blue-600">
                              {product.status === 'vendido' ? formatCurrency(product.salePrice) : '-'}
                            </span>
                            <span className="text-xs text-slate-400">
                              {product.status === 'vendido' ? formatDate(product.saleDate) : ''}
                            </span>
                          </div>
                        )}
                      </td>

                      {/* Coluna de Ações */}
                      <td className="p-4 text-right">
                        {sellingId === product.id ? (
                          <div className="flex items-center justify-end gap-2">
                            <button 
                              onClick={() => setSellingId(null)}
                              className="p-1.5 text-slate-400 hover:bg-slate-200 rounded-md transition-colors"
                              title="Cancelar"
                            >
                              <X className="w-4 h-4" />
                            </button>
                            <button 
                              onClick={() => handleConfirmSell(product.id)}
                              className="p-1.5 bg-emerald-500 text-white hover:bg-emerald-600 rounded-md transition-colors"
                              title="Confirmar Venda"
                            >
                              <Check className="w-4 h-4" />
                            </button>
                          </div>
                        ) : (
                          <div className="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            {product.status === 'estoque' && (
                              <button 
                                onClick={() => handleStartSell(product)}
                                className="text-sm bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1.5 rounded-md font-medium transition-colors"
                              >
                                Vender
                              </button>
                            )}
                            <button 
                              onClick={() => handleDelete(product.id)}
                              className="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors"
                              title="Excluir"
                            >
                              <X className="w-4 h-4" />
                            </button>
                          </div>
                        )}
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </section>

      </main>
    </div>
  );
}
